<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cuit.hyl.graduation.sys.dao.TbPermissionDao">

    <resultMap type="cuit.hyl.graduation.sys.entity.TbPermission" id="TbPermissionMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="parentId" column="parent_id" jdbcType="INTEGER"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="enname" column="enname" jdbcType="VARCHAR"/>
        <result property="url" column="url" jdbcType="VARCHAR"/>
        <result property="description" column="description" jdbcType="VARCHAR"/>
        <result property="created" column="created" jdbcType="TIMESTAMP"/>
        <result property="updated" column="updated" jdbcType="TIMESTAMP"/>
        <result property="roleId" column="roleId" jdbcType="INTEGER"/>
        <result property="permissionId" column="permissionId" jdbcType="INTEGER"/>
    </resultMap>
    <resultMap id="permissionTree" type="cuit.hyl.graduation.sys.entity.vo.PermissionTree">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="parentId" column="parent_id" jdbcType="INTEGER"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
    </resultMap>
    <resultMap id="menuTree" type="cuit.hyl.graduation.sys.entity.vo.MenuTree">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="parentId" column="parent_id" jdbcType="INTEGER"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="odr" column="odr" jdbcType="INTEGER"/>
    </resultMap>
    <resultMap type="cuit.hyl.graduation.sys.entity.TbRoleMenu" id="TbRoleMenuMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="roleId" column="role_id" jdbcType="INTEGER"/>
        <result property="menuId" column="menu_id" jdbcType="INTEGER"/>
    </resultMap>

    <select id="queryByUserId" resultMap="TbPermissionMap">
        SELECT
        p.*
        FROM
        graduation_authority.tb_user AS u
        LEFT JOIN graduation_authority.tb_user_role AS ur
        ON u.id = ur.user_id
        LEFT JOIN graduation_authority.tb_role AS r
        ON r.id = ur.role_id AND r.parent_id = 0
        LEFT JOIN graduation_authority.tb_role_permission AS rp
        ON r.id = rp.role_id
        LEFT JOIN graduation_authority.tb_permission AS p
        ON p.id = rp.permission_id
        WHERE u.id = #{id}
    </select>

    <!--查询用户-->
    <select id="queryAllPermission" resultMap="TbPermissionMap">
        select
            id, name, enname, url, description, created, updated
        from graduation_authority.tb_permission
        <where>
            <if test="name != null and name != '' ">
                and name = #{name}
            </if>
            <if test="enname != null and enname != '' ">
                and enname = #{enname}
            </if>
            <if test="url != null and url != ''">
                and url like "%"#{url}"%"
            </if>
            <if test="description != null and description != ''">
                and description like "%"#{description}"%"
            </if>
        </where>
    </select>

    <!--新增资源权限-->
    <insert id="insertPermission" >
        INSERT INTO graduation_authority.tb_permission
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null and '' != id">
                id,
            </if>
            <if test="name != null and '' != name">
                name,
            </if>
            <if test="enname != null and '' != enname">
                enname,
            </if>
            <if test="url != null and '' != url">
                url,
            </if>
            <if test="description != null and '' != description">
                description,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null and '' != id">
                #{id},
            </if>
            <if test="name != null and '' != name">
                #{name},
            </if>
            <if test="enname != null and '' != enname">
                #{enname},
            </if>
            <if test="url != null and '' != url">
                #{url},
            </if>
            <if test="description != null and '' != description">
                #{description},
            </if>
        </trim>
    </insert>

    <update id="updatePermission">
        UPDATE graduation_authority.tb_permission
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null and '' != name">
                name= #{name},
            </if>
            <if test="enname != null and '' != enname">
                enname= #{enname},
            </if>
            <if test="url != null and '' != url">
                url= #{url},
            </if>
            <if test="description != null and '' != description">
                description= #{description},
            </if>
        </trim>
        where id= #{id}
    </update>

    <!--删除资源权限-->
    <delete id="deletePermission">
        DELETE FROM graduation_authority.tb_permission WHERE id = #{id}
    </delete>

    <!--批量删除-->
    <delete id="multipleDeletePermission">
        DELETE FROM graduation_authority.tb_permission WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

<!--   5;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
    <!--通过角色Id查找权限-->
    <select id="queryPermissionByRoleId">
        SELECT * FROM graduation_authority.tb_permission WHERE id = #{id}
    </select>

    <!--增加角色权限-->
    <insert id="insertRolePermission">
        INSERT INTO graduation_authority.tb_role_permission (role_id, permission_id)
        VALUES (#{roleId}, #{permissionId})
    </insert>

    <!--删除角色权限-->
    <delete id="deleteRolePermission">
        DELETE FROM graduation_authority.tb_role_permission
        WHERE id IN
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

   <!-- -&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-->
    <select id="permissionIds" resultType="Long">
        SELECT
            p.id
        FROM
            graduation_authority.tb_role_permission AS rp
                LEFT JOIN graduation_authority.tb_permission AS p ON rp.permission_id = p.id
        WHERE
            rp.role_id = #{id}
    </select>
    <select id="menuIds" resultType="Long">
        SELECT
            m.id
        FROM
            graduation_authority.tb_role_menu AS rm
                LEFT JOIN graduation_authority.tb_menu AS m ON rm.menu_id = m.id
        WHERE
            rm.role_id = #{id}
    </select>

    <select id="permissionTree" resultMap="permissionTree">
        SELECT *
        FROM graduation_authority.tb_permission
    </select>
    <select id="menuTree" resultMap="menuTree">
        SELECT *
        FROM graduation_authority.tb_menu
    </select>

    <!--删除某角色所有目录-->
    <delete id="multipleDeleteAllRoleMenu">
        DELETE FROM graduation_authority.tb_role_menu WHERE role_id = #{id}
    </delete>
    <!--删除某角色所有资源-->
    <delete id="multipleDeleteAllRolePermission">
        DELETE FROM graduation_authority.tb_role_permission WHERE role_id = #{id}
    </delete>

    <insert id="multipleInsertRoleMenu">
        INSERT INTO graduation_authority.tb_role_menu (id, role_id, menu_id) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.roleId},#{item.menuId})
        </foreach>
    </insert>
    <insert id="multipleInsertRolePermission">
        INSERT INTO graduation_authority.tb_role_permission (id, role_id, permission_id) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.id},#{item.roleId},#{item.permissionId})
        </foreach>
    </insert>

</mapper>